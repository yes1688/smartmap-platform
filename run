#!/bin/bash
# æ™ºæ…§ç©ºé–“å¹³å° - çµ±ä¸€ç®¡ç†å·¥å…·
# ç”¨é€”ï¼šä¸€å€‹è…³æœ¬ç®¡ç†æ‰€æœ‰ç’°å¢ƒ

set -e

# é¡è‰²
G='\033[0;32m'
Y='\033[1;33m'
R='\033[0;31m'
B='\033[0;36m'
NC='\033[0m'

# é¡¯ç¤º Logo
show_logo() {
    echo -e "${B}"
    cat << "EOF"
    _____ __  __    _    ____ _____ __  __    _    ____
   / ____|  \/  |  / \  |  _ \_   _|  \/  |  / \  |  _ \
   \___ \| |\/| | / _ \ | |_) || | | |\/| | / _ \ | |_) |
    ___) | |  | |/ ___ \|  _ < | | | |  | |/ ___ \|  __/
   |____/|_|  |_/_/   \_\_| \_\|_| |_|  |_/_/   \_\_|

   æ™ºæ…§ç©ºé–“å¹³å° - Intelligent Spatial Platform
EOF
    echo -e "${NC}"
}

# é¡¯ç¤ºå¹«åŠ©
show_help() {
    show_logo
    cat << EOF
${G}ä½¿ç”¨æ–¹å¼:${NC} ./run [command]

${Y}ğŸ”§ é–‹ç™¼ç’°å¢ƒ (ç†±é‡è¼‰)${NC}
  ${G}dev${NC}         å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
  ${G}dev-stop${NC}    åœæ­¢é–‹ç™¼ç’°å¢ƒ
  ${G}dev-logs${NC}    æŸ¥çœ‹é–‹ç™¼ç’°å¢ƒæ—¥èªŒ

${Y}ğŸš€ ç”Ÿç”¢ç’°å¢ƒ${NC}
  ${G}prod${NC}        å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒ
  ${G}prod-stop${NC}   åœæ­¢ç”Ÿç”¢ç’°å¢ƒ
  ${G}prod-logs${NC}   æŸ¥çœ‹ç”Ÿç”¢ç’°å¢ƒæ—¥èªŒ

${Y}ğŸ› ï¸ å·¥å…·æŒ‡ä»¤${NC}
  ${G}build${NC}       æ§‹å»ºå‰ç«¯è³‡æº
  ${G}test-run${NC}    é‹è¡Œå¾Œç«¯æ¸¬è©¦
  ${G}shell${NC}       é€²å…¥å¾Œç«¯å®¹å™¨
  ${G}db${NC}          é€²å…¥æ•¸æ“šåº«
  ${G}status${NC}      æŸ¥çœ‹æ‰€æœ‰ç’°å¢ƒç‹€æ…‹
  ${G}clean${NC}       æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œè³‡æº

${Y}ğŸ“š ç¯„ä¾‹${NC}
  ./run dev          # æœ¬æ©Ÿé–‹ç™¼ï¼ˆæœ€å¸¸ç”¨ï¼‰
  ./run prod         # ç”Ÿç”¢ç’°å¢ƒ
  ./run build        # æ§‹å»ºå‰ç«¯
  ./run test-run     # é‹è¡Œæ¸¬è©¦

${Y}ğŸ“ è¨ªå•åœ°å€${NC}
  ${B}çµ±ä¸€ç«¯å£: http://localhost:7004${NC}
  ï¼ˆé–‹ç™¼å’Œç”Ÿç”¢ç’°å¢ƒéƒ½ä½¿ç”¨ç›¸åŒç«¯å£ï¼‰

EOF
}

# é–‹ç™¼ç’°å¢ƒ
dev_start() {
    echo -e "${G}ğŸ”§ å•Ÿå‹•é–‹ç™¼ç’°å¢ƒï¼ˆç†±é‡è¼‰ï¼‰...${NC}"
    podman-compose -f podman-compose.dev.yml up -d
    echo -e "${G}âœ… é–‹ç™¼ç’°å¢ƒå·²å•Ÿå‹•${NC}"
    echo -e "${B}è¨ªå•: http://localhost:7004${NC}"
}

dev_stop() {
    echo -e "${Y}â¹ï¸  åœæ­¢é–‹ç™¼ç’°å¢ƒ...${NC}"
    podman-compose -f podman-compose.dev.yml down
    echo -e "${G}âœ… å·²åœæ­¢${NC}"
}

dev_logs() {
    podman-compose -f podman-compose.dev.yml logs -f
}

# ç”Ÿç”¢ç’°å¢ƒ
prod_start() {
    echo -e "${G}ğŸš€ å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒ...${NC}"

    # æª¢æŸ¥ .env
    if [ ! -f .env ]; then
        echo -e "${Y}âš ï¸  .env ä¸å­˜åœ¨ï¼Œå¾ .env.example è¤‡è£½...${NC}"
        cp .env.example .env
    fi

    # æ§‹å»ºå‰ç«¯
    echo -e "${G}ğŸ“¦ æ§‹å»ºå‰ç«¯...${NC}"
    cd web && npm run build && cd .. || { echo -e "${R}âŒ å‰ç«¯æ§‹å»ºå¤±æ•—${NC}"; exit 1; }

    # å•Ÿå‹•å®¹å™¨
    podman-compose --profile prod up -d

    echo -e "${G}âœ… ç”Ÿç”¢ç’°å¢ƒå·²å•Ÿå‹•${NC}"
    echo -e "${B}è¨ªå•: http://localhost:7004${NC}"
    echo -e "${Y}ğŸ’¡ ç­‰å¾… 30 ç§’è®“æœå‹™å®Œå…¨å•Ÿå‹•...${NC}"
}

prod_stop() {
    echo -e "${Y}â¹ï¸  åœæ­¢ç”Ÿç”¢ç’°å¢ƒ...${NC}"
    podman-compose --profile prod down
    echo -e "${G}âœ… å·²åœæ­¢${NC}"
}

prod_logs() {
    podman-compose --profile prod logs -f
}

# å·¥å…·æŒ‡ä»¤
build_frontend() {
    echo -e "${G}ğŸ“¦ æ§‹å»ºå‰ç«¯è³‡æº...${NC}"
    cd web && npm install && npm run build && cd ..
    echo -e "${G}âœ… å‰ç«¯æ§‹å»ºå®Œæˆ${NC}"
}

run_tests() {
    echo -e "${G}ğŸ§ª é‹è¡Œå¾Œç«¯æ¸¬è©¦...${NC}"

    # æª¢æŸ¥é–‹ç™¼ç’°å¢ƒæ˜¯å¦é‹è¡Œ
    if ! podman ps | grep -q spatial-backend-dev; then
        echo -e "${Y}é–‹ç™¼ç’°å¢ƒæœªé‹è¡Œï¼Œå•Ÿå‹•ä¸­...${NC}"
        dev_start
        sleep 10
    fi

    podman exec spatial-backend-dev go test ./internal/... -v -cover
}

enter_shell() {
    # å„ªå…ˆé–‹ç™¼ç’°å¢ƒ
    if podman ps | grep -q spatial-backend-dev; then
        echo -e "${G}ğŸš é€²å…¥é–‹ç™¼ç’°å¢ƒå¾Œç«¯å®¹å™¨...${NC}"
        podman exec -it spatial-backend-dev /bin/sh
    elif podman ps | grep -q spatial-app; then
        echo -e "${G}ğŸš é€²å…¥ç”Ÿç”¢ç’°å¢ƒå¾Œç«¯å®¹å™¨...${NC}"
        podman exec -it spatial-app /bin/sh
    else
        echo -e "${R}âŒ æ²’æœ‰é‹è¡Œä¸­çš„å¾Œç«¯å®¹å™¨${NC}"
        exit 1
    fi
}

enter_db() {
    # å„ªå…ˆé–‹ç™¼ç’°å¢ƒ
    if podman ps | grep -q spatial-postgres-dev; then
        echo -e "${G}ğŸ—„ï¸  é€²å…¥é–‹ç™¼ç’°å¢ƒæ•¸æ“šåº«...${NC}"
        podman exec -it spatial-postgres-dev psql -U spatial_user -d spatial_db
    elif podman ps | grep -q spatial-postgres; then
        echo -e "${G}ğŸ—„ï¸  é€²å…¥ç”Ÿç”¢ç’°å¢ƒæ•¸æ“šåº«...${NC}"
        podman exec -it spatial-postgres psql -U spatial_user -d spatial_db
    else
        echo -e "${R}âŒ æ²’æœ‰é‹è¡Œä¸­çš„æ•¸æ“šåº«å®¹å™¨${NC}"
        exit 1
    fi
}

show_status() {
    echo -e "${G}ğŸ“Š ç’°å¢ƒç‹€æ…‹:${NC}\n"

    echo -e "${Y}é–‹ç™¼ç’°å¢ƒ:${NC}"
    podman ps --filter "name=spatial.*-dev" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "æœªé‹è¡Œ"

    echo -e "\n${Y}ç”Ÿç”¢ç’°å¢ƒ:${NC}"
    podman ps --filter "name=spatial-(app|nginx|postgres)" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "æœªé‹è¡Œ"
}

clean_all() {
    echo -e "${R}ğŸ§¹ æ¸…ç†æ‰€æœ‰ç’°å¢ƒ...${NC}"
    echo -e "${Y}âš ï¸  é€™å°‡åˆªé™¤æ‰€æœ‰å®¹å™¨ã€ç¶²çµ¡å’Œæ•¸æ“šå·${NC}"
    read -p "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ(y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        podman-compose -f podman-compose.dev.yml down -v 2>/dev/null || true
        podman-compose --profile prod down -v 2>/dev/null || true
        echo -e "${G}âœ… æ¸…ç†å®Œæˆ${NC}"
    fi
}

# ä¸»å‡½æ•¸
main() {
    case "${1:-help}" in
        # é–‹ç™¼ç’°å¢ƒ
        dev)
            dev_start
            ;;
        dev-stop)
            dev_stop
            ;;
        dev-logs)
            dev_logs
            ;;

        # ç”Ÿç”¢ç’°å¢ƒ
        prod)
            prod_start
            ;;
        prod-stop)
            prod_stop
            ;;
        prod-logs)
            prod_logs
            ;;

        # å·¥å…·
        build)
            build_frontend
            ;;
        test-run)
            run_tests
            ;;
        shell)
            enter_shell
            ;;
        db)
            enter_db
            ;;
        status)
            show_status
            ;;
        clean)
            clean_all
            ;;

        # å¹«åŠ©
        help|--help|-h|*)
            show_help
            ;;
    esac
}

main "$@"
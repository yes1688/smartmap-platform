# Frontend Build Container - åªæ§‹å»ºå‰ç«¯ï¼Œä¸é‹è¡Œ
# ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒï¼Œå°‡æ§‹å»ºå¥½çš„ dist/ è¤‡è£½åˆ° volume

FROM node:18-alpine AS builder

WORKDIR /app

# è¤‡è£½ package æ–‡ä»¶
COPY package*.json ./

# å®‰è£ä¾è³´
RUN npm ci

# è¤‡è£½æºä»£ç¢¼
COPY . .

# æ§‹å»ºæ‡‰ç”¨
RUN npm run build

# ä½¿ç”¨è¼•é‡ç´šæ˜ åƒä¾†æŒæœ‰æ§‹å»ºçµæœ
FROM alpine:latest

WORKDIR /dist

# å¾ builder éšæ®µè¤‡è£½æ§‹å»ºç”¢ç‰©
COPY --from=builder /app/dist /dist

# é©—è­‰æª”æ¡ˆç¢ºå¯¦å­˜åœ¨ä¸¦ç­‰å¾… volume åŒæ­¥
# 1. åˆ—å‡ºæ‰€æœ‰æª”æ¡ˆç¢ºèª
# 2. è¨ˆç®—æª”æ¡ˆæ•¸é‡
# 3. ç­‰å¾…ä¸€æ®µæ™‚é–“ç¢ºä¿ volume å®Œå…¨åŒæ­¥
# 4. å†æ¬¡é©—è­‰æª”æ¡ˆæ•¸é‡æ²’æœ‰è®ŠåŒ–ï¼ˆç¢ºèªåŒæ­¥ç©©å®šï¼‰
CMD ["sh", "-c", "\
  echo 'ğŸ“¦ Frontend build completed. Files in container:' && \
  ls -lh /dist && \
  echo '' && \
  FILE_COUNT=$(find /dist -type f | wc -l) && \
  echo \"ğŸ“Š Total files: $FILE_COUNT\" && \
  echo 'â³ Waiting for volume sync (10 seconds)...' && \
  sleep 10 && \
  VERIFY_COUNT=$(find /dist -type f | wc -l) && \
  echo \"âœ… Volume sync verified. Files: $VERIFY_COUNT\" && \
  if [ \"$FILE_COUNT\" -eq \"$VERIFY_COUNT\" ]; then \
    echo 'âœ… Volume sync completed successfully'; \
  else \
    echo 'âš ï¸  Warning: File count mismatch!'; \
  fi \
"]
